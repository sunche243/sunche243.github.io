<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QR 주문 관리</title>
  <style>
    body {
        font-family: sans-serif;
        padding: 20px;
    }

    .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
    }

    @media (min-width: 600px) {
        .grid {
            grid-template-columns: 1fr 1fr;
        }
    }

    .order {
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 12px;
        background-color: white;
    }

    .order.completed {
        background-color: #d4edda;
        border-color: #28a745;
    }

    .order p {
        margin: 4px 0;
    }

    .toggle-btn{
        margin-right: 8px;
        margin-top: 6px;
        padding: 6px 12px;
        background-color: rgb(70, 180, 224);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }

    .delete-btn{
        margin-right: 8px;
        margin-top: 6px;
        padding: 6px 12px;
        background-color: white;
        color: black;
        border: 1px solid gray;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      onSnapshot,
      doc,
      updateDoc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC4p0c57uJHLj2un5W2Mr5Us0U8zw-4WzU",
      authDomain: "accounting-pub.firebaseapp.com",
      projectId: "accounting-pub"
    };

    const priceMap = {
      "불고기덮밥": 7000,
      "제육덮밥": 7000,
      "콜라": 2000,
      "사이다": 2000
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const ordersDiv = document.getElementById("orders");
    const q = query(collection(db, "orders"), orderBy("timestamp", "desc"));

    onSnapshot(q, (snapshot) => {
      ordersDiv.innerHTML = '';
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const id = docSnap.id;

        const total = data.items.reduce((sum, item) => sum + (priceMap[item] || 0), 0);

        const div = document.createElement("div");
        div.className = "order" + (data.completed ? " completed" : "");

        const btnText = data.completed ? "확인 취소" : "확인";

        div.innerHTML = `
          <p><strong>테이블 ${data.table}</strong> | 입금자: ${data.name}</p>
          <p>주문: ${data.items.join(", ")}</p>
          <p><strong>총 금액: ${total.toLocaleString()}원</strong></p>
          <small>${data.timestamp}</small><br>
          <button class="toggle-btn">${btnText}</button>
          <button class="delete-btn">삭제</button>
        `;

        // 완료 버튼 토글
        div.querySelector(".toggle-btn").addEventListener("click", async () => {
          await updateDoc(doc(db, "orders", id), {
            completed: !data.completed,
          });
        });

        // 삭제 버튼
        div.querySelector(".delete-btn").addEventListener("click", async () => {
          if (confirm("정말로 삭제하시겠습니까?")) {
            await deleteDoc(doc(db, "orders", id));
          }
        });

        ordersDiv.appendChild(div);
      });
    });
  </script>
</head>
<body>
  <h2>주문 목록</h2>
  <div class="grid" id="orders"></div>
</body>
</html>